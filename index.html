<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>2026 日本關西之旅</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
    [v-cloak] { display: none; }
    .card-shadow { box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05); }
    .tag-food { @apply bg-orange-100 text-orange-700; }
    .tag-buy { @apply bg-red-100 text-red-700; }
    .tag-tip { @apply bg-indigo-100 text-indigo-700; }
  </style>
</head>
<body>

<div id="app" v-cloak class="flex flex-col h-screen">

  <header class="bg-white px-6 py-4 flex justify-between items-center border-b border-slate-100 sticky top-0 z-10">
    <h1 class="text-xl font-bold">Japan 2026</h1>
    <div class="text-sm text-slate-500">
      Day {{ activeDay + 1 }}
    </div>
  </header>

  <main class="flex-1 overflow-y-auto p-4 space-y-4">

    <!-- 行程 -->
    <div>
      <h2 class="font-bold text-lg mb-2">行程</h2>
      <div class="flex gap-2 overflow-x-auto pb-2">
        <button v-for="(day, idx) in itinerary" :key="idx" @click="activeDay=idx"
          :class="activeDay===idx ? 'bg-indigo-600 text-white' : 'bg-white text-slate-400 border border-slate-200'"
          class="flex-shrink-0 w-16 h-16 rounded-xl flex flex-col items-center justify-center">
          <span class="text-xs">1/{{19+idx}}</span>
          <span class="text-sm font-bold">D{{ idx+1 }}</span>
        </button>
      </div>

      <div v-if="itinerary[activeDay]" class="mt-3 space-y-2">
        <div v-for="(item, index) in itinerary[activeDay].schedule" :key="index" class="bg-white p-3 rounded-xl card-shadow flex justify-between items-center">
          <div>
            <div class="text-sm font-bold">{{ item.time }} - {{ item.place }}</div>
            <div class="text-xs text-slate-500">{{ getTypeLabel(item.type) }}</div>
          </div>
          <button @click="removeScheduleItem(index)" class="text-red-500"><i class="fa-solid fa-trash"></i></button>
        </div>
        <div v-if="itinerary[activeDay].schedule.length===0" class="text-center text-slate-400 py-5">今天還沒有安排行程</div>
      </div>

      <button @click="showAddModal=true" class="mt-3 bg-indigo-600 text-white py-2 px-4 rounded-xl">新增行程</button>
    </div>

    <!-- 記帳 -->
    <div>
      <h2 class="font-bold text-lg mb-2">個人記帳 (本地)</h2>
      <div class="bg-white p-4 rounded-xl card-shadow space-y-2">
        <div class="flex gap-2">
          <input v-model="newExpense.item" placeholder="項目" class="flex-1 border rounded-xl px-3 py-2">
          <input v-model.number="newExpense.amount" type="number" placeholder="金額" class="w-24 border rounded-xl px-3 py-2">
          <button @click="addExpense" class="bg-indigo-600 text-white px-4 rounded-xl">新增</button>
        </div>

        <div v-for="(exp, i) in expenses" :key="i" class="flex justify-between items-center bg-slate-50 p-2 rounded-xl">
          <span>{{ exp.item }} - ¥{{ exp.amount }}</span>
          <button @click="removeExpense(i)" class="text-red-500"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div v-if="expenses.length===0" class="text-center text-slate-400 py-3">目前沒有支出紀錄</div>
      </div>
    </div>

  </main>

  <!-- 新增行程 Modal -->
  <div v-if="showAddModal" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4" @click.self="showAddModal=false">
    <div class="bg-white rounded-xl p-6 w-full max-w-sm">
      <h3 class="font-bold mb-3">新增 Day {{ activeDay+1 }} 行程</h3>
      <div class="space-y-2">
        <input v-model="newItem.time" type="time" class="w-full border rounded-xl px-3 py-2">
        <select v-model="newItem.type" class="w-full border rounded-xl px-3 py-2">
          <option value="sightseeing">景點</option>
          <option value="food">美食</option>
          <option value="buy">購物</option>
          <option value="transport">交通</option>
        </select>
        <input v-model="newItem.place" placeholder="地點名稱" class="w-full border rounded-xl px-3 py-2">
      </div>
      <div class="flex gap-2 mt-4">
        <button @click="showAddModal=false" class="flex-1 bg-gray-200 rounded-xl py-2">取消</button>
        <button @click="addScheduleItem" class="flex-1 bg-indigo-600 text-white rounded-xl py-2">新增</button>
      </div>
    </div>
  </div>

</div>

<script type="module">
import { createApp, ref, onMounted } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

// Firebase 設定
const firebaseConfig = {
  apiKey: "AIzaSyBM7ZkACa3GCyDHyM6-cvAptRdTLrP1Vz4",
  authDomain: "project-6278516196770343325.firebaseapp.com",
  projectId: "project-6278516196770343325",
  storageBucket: "project-6278516196770343325.firebasestorage.app",
  messagingSenderId: "1092753345526",
  appId: "1:1092753345526:web:83c76c77e00a6a2ad255d7",
  measurementId: "G-JZ408WWH2S"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

createApp({
  setup(){
    const activeDay = ref(0);
    const itinerary = ref([
      { date: '1/19', location: '名古屋', schedule: [] },
      { date: '1/20', location: '下呂', schedule: [] },
      { date: '1/21', location: '大阪', schedule: [] },
      { date: '1/22', location: 'USJ', schedule: [] },
      { date: '1/23', location: '大阪', schedule: [] },
      { date: '1/24', location: '奈良', schedule: [] },
      { date: '1/25', location: '大阪', schedule: [] },
      { date: '1/26', location: '大阪', schedule: [] },
      { date: '1/27', location: '大阪', schedule: [] },
      { date: '1/28', location: '返程', schedule: [] }
    ]);
    const showAddModal = ref(false);
    const newItem = ref({ time:'10:00', place:'', type:'sightseeing' });

    const expenses = ref([]);
    const newExpense = ref({item:'',amount:''});

    // 本地存記帳資料
    onMounted(()=>{
      const savedExpenses = localStorage.getItem('expenses');
      if(savedExpenses) expenses.value = JSON.parse(savedExpenses);

      // Firebase 行程同步
      onSnapshot(doc(db, "trips", "shared_trip_data"), (docSnap)=>{
        if(docSnap.exists()){
          const data = docSnap.data();
          if(data.itinerary) itinerary.value = data.itinerary;
        }
      });
    });

    const saveItinerary = async ()=>{
      await setDoc(doc(db,"trips","shared_trip_data"), { itinerary: itinerary.value, lastUpdated: new Date() });
    };

    const addScheduleItem = ()=>{
      if(!newItem.value.place) return;
      itinerary.value[activeDay.value].schedule.push({...newItem.value});
      itinerary.value[activeDay.value].schedule.sort((a,b)=>a.time.localeCompare(b.time));
      newItem.value = { time:'10:00', place:'', type:'sightseeing' };
      showAddModal.value = false;
      saveItinerary();
    };

    const removeScheduleItem = (idx)=>{
      if(confirm('刪除此行程？')){
        itinerary.value[activeDay.value].schedule.splice(idx,1);
        saveItinerary();
      }
    };

    const addExpense = ()=>{
      if(!newExpense.value.item || !newExpense.value.amount) return;
      expenses.value.unshift({...newExpense.value});
      newExpense.value = {item:'',amount:''};
      localStorage.setItem('expenses', JSON.stringify(expenses.value));
    };

    const removeExpense = (idx)=>{
      if(confirm('刪除此筆支出？')){
        expenses.value.splice(idx,1);
        localStorage.setItem('expenses', JSON.stringify(expenses.value));
      }
    };

    const getTypeLabel = (t)=>({sightseeing:'景點',food:'美食',buy:'購物',transport:'交通'}[t]||'其他');

    return { activeDay, itinerary, showAddModal, newItem, addScheduleItem, removeScheduleItem, expenses, newExpense, addExpense, removeExpense, getTypeLabel };
  }
}).mount('#app');
</script>

</body>
</html>
