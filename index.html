<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>2026 æ—¥æœ¬é—œè¥¿ä¹‹æ—…</title>
    <meta name="theme-color" content="#ffffff" />
    <link rel="manifest" href="manifest.json" />

    <!-- Tailwind + Vue (global) + FontAwesome + Google Font -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet" />

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .tag-food { @apply bg-orange-100 text-orange-700; }
        .tag-buy { @apply bg-red-100 text-red-700; }
        .tag-tip { @apply bg-indigo-100 text-indigo-700; }
        .card-shadow { box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05); }

        /* å‹•ç•«ç‰¹æ•ˆ */
        .modal-enter-active, .modal-leave-active { transition: opacity 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }
        .radar-ping { animation: ping 1.5s cubic-bezier(0, 0, 0.2, 1) infinite; }
        @keyframes ping { 75%, 100% { transform: scale(2); opacity: 0; } }
        [v-cloak] { display: none; }

        /* small helper for safe bottom padding on nav */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

<div id="app" v-cloak class="flex flex-col h-full relative">

    <header class="bg-white/90 backdrop-blur-md px-6 py-4 flex justify-between items-center z-20 border-b border-slate-100 sticky top-0">
        <div>
            <h1 class="text-xl font-bold tracking-tight text-slate-900">Japan 2026</h1>
            <div class="flex items-center gap-2">
                <p class="text-xs text-slate-500">10 Days Kansai & Nagoya</p>
                <span v-if="isSyncing" class="text-[10px] text-blue-500 flex items-center bg-blue-50 px-2 py-0.5 rounded-full"><i class="fa-solid fa-rotate fa-spin mr-1"></i>åŒæ­¥ä¸­</span>
                <span v-else class="text-[10px] text-green-500 flex items-center bg-green-50 px-2 py-0.5 rounded-full"><i class="fa-solid fa-check mr-1"></i>å·²åŒæ­¥</span>
            </div>
        </div>
        <div class="flex items-center gap-2 bg-slate-100 px-3 py-1.5 rounded-full">
            <span class="text-xs font-bold text-slate-500">Day {{ activeDay + 1 }}</span>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto hide-scrollbar bg-slate-50 safe-bottom pb-24 relative">

        <div v-if="currentTab === 'trip'" class="p-4 space-y-6">
            <div class="flex gap-3 overflow-x-auto hide-scrollbar pb-2">
                <button v-for="(day, index) in itinerary" :key="index"
                    @click="activeDay = index"
                    :class="activeDay === index ? 'bg-slate-800 text-white shadow-lg scale-105' : 'bg-white text-slate-400 border border-slate-100'"
                    class="flex-shrink-0 w-14 h-16 rounded-2xl flex flex-col items-center justify-center transition-all duration-300">
                    <span class="text-xs font-medium">1/{{ 19 + index }}</span>
                    <span class="text-xl font-bold">D{{ index + 1 }}</span>
                </button>
            </div>

            <div class="bg-gradient-to-r from-blue-500 to-indigo-600 rounded-3xl p-5 text-white shadow-lg shadow-indigo-200">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="text-indigo-100 text-sm mb-1"><i class="fa-solid fa-location-dot mr-1"></i> {{ itinerary[activeDay]?.location || 'Loading...' }}</div>
                        <div class="text-3xl font-bold">{{ getWeather(activeDay).temp }}Â°C</div>
                        <div class="text-sm opacity-90">{{ getWeather(activeDay).desc }}</div>
                    </div>
                    <i :class="getWeather(activeDay).icon" class="text-4xl opacity-80"></i>
                </div>
            </div>

            <div class="space-y-4" v-if="itinerary[activeDay]">
                <div v-for="(item, idx) in itinerary[activeDay].schedule" :key="idx" class="bg-white rounded-2xl p-4 card-shadow border border-slate-50 relative overflow-hidden group">
                    <div class="absolute left-0 top-0 bottom-0 w-1" :class="getTypeColor(item.type)"></div>
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <span class="font-mono text-sm font-bold text-slate-400 bg-slate-50 px-2 py-0.5 rounded">{{ item.time }}</span>
                            <span class="text-xs font-medium uppercase tracking-wider text-slate-400">{{ getTypeLabel(item.type) }}</span>
                        </div>
                        <div class="flex gap-2">
                            <button @click="removeScheduleItem(idx)" class="text-slate-300 hover:text-red-500 w-8 h-8 flex items-center justify-center">
                                <i class="fa-solid fa-trash-can text-sm"></i>
                            </button>
                            <a :href="'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(item.place)" target="_blank"
                               class="bg-slate-900 text-white w-8 h-8 rounded-full flex items-center justify-center shadow-md active:scale-90 transition-transform">
                                <i class="fa-solid fa-location-arrow text-xs"></i>
                            </a>
                        </div>
                    </div>
                    <h3 class="text-lg font-bold text-slate-800 mb-1 leading-tight">{{ item.place }}</h3>

                    <div v-if="item.tips && item.tips.length > 0" class="flex flex-wrap gap-2 mt-3">
                        <span v-for="tip in item.tips" :key="tip.text" class="text-xs px-2 py-1 rounded-md font-medium" :class="getTipClass(tip.tag)">
                            <i class="fa-solid mr-1" :class="getTipIcon(tip.tag)"></i>{{ tip.text }}
                        </span>
                    </div>
                </div>
                <div v-if="itinerary[activeDay].schedule.length === 0" class="text-center py-10 text-slate-400">
                    <p>ä»Šå¤©é‚„æ²’æœ‰å®‰æ’è¡Œç¨‹</p>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'utils'" class="p-4 space-y-4">

            <div class="bg-gradient-to-br from-yellow-400 to-orange-500 rounded-2xl p-6 text-white shadow-lg relative overflow-hidden active:scale-95 transition-transform" @click="findKujiShops">
                <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-white/20 rounded-full blur-xl"></div>
                <div class="relative z-10 flex justify-between items-center">
                    <div>
                        <h3 class="text-xl font-bold mb-1"><i class="fa-solid fa-ticket mr-2"></i>ä¸€ç•ªè³é›·é”</h3>
                        <p class="text-yellow-50 text-sm">æœå°‹é™„è¿‘å¯æŠ½çåº—å®¶</p>
                    </div>
                    <div class="relative">
                        <span class="absolute inline-flex h-full w-full rounded-full bg-white opacity-30 radar-ping"></span>
                        <i class="fa-solid fa-location-crosshairs text-3xl"></i>
                    </div>
                </div>
            </div>

            <h2 class="text-xl font-bold px-2 mt-6 mb-2">æ—…é€”è³‡è¨Š</h2>

            <div class="bg-white rounded-2xl p-5 card-shadow">
                <h3 class="font-bold text-slate-800 mb-4 flex items-center"><i class="fa-solid fa-plane-departure text-indigo-500 mr-2"></i> èˆªç­è³‡è¨Š</h3>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between border-b border-slate-50 pb-2"><span class="text-slate-500">å»ç¨‹ 01/19</span><span class="font-medium">TPE -> NGO (åå¤å±‹)</span></div>
                    <div class="flex justify-between"><span class="text-slate-500">å›ç¨‹ 01/28</span><span class="font-medium">KIX (å¤§é˜ª) -> TPE</span></div>
                </div>
            </div>

            <div class="bg-white rounded-2xl p-5 card-shadow">
                <h3 class="font-bold text-slate-800 mb-4 flex items-center"><i class="fa-solid fa-bed text-indigo-500 mr-2"></i> ä½å®¿æ¸…å–®</h3>
                <div class="space-y-4">
                    <div v-for="hotel in hotels" class="border-b border-slate-100 last:border-0 pb-2 last:pb-0 relative">
                        <div class="font-medium text-slate-800">{{ hotel.name }}</div>
                        <div class="text-xs text-slate-500 mt-1"><i class="fa-solid fa-map-pin mr-1"></i>{{ hotel.address }}</div>
                        <a :href="'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(hotel.name)" target="_blank" class="absolute right-0 top-2 text-blue-500 bg-blue-50 px-3 py-1 rounded-full text-xs font-medium">å°èˆª</a>
                    </div>
                </div>
            </div>

            <div class="bg-red-50 rounded-2xl p-5 border border-red-100">
                <h3 class="font-bold text-red-800 mb-2"><i class="fa-solid fa-triangle-exclamation mr-2"></i>ç·Šæ€¥è¯çµ¡</h3>
                <div class="text-sm text-red-600 space-y-2">
                    <div class="flex justify-between"><span class="font-bold">è­¦å¯Ÿ</span> <span>110</span></div>
                    <div class="flex justify-between"><span class="font-bold">æ•‘è­·/ç«è­¦</span> <span>119</span></div>
                    <div class="mt-2 pt-2 border-t border-red-200 text-xs">
                        é§æ—¥ä»£è¡¨è™•: +81-3-3280-7811<br>
                        æ—…å¤–åœ‹äººæ€¥é›£æ•‘åŠ©: +886-800-085-095
                    </div>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'budget'" class="p-4">
            <div class="bg-white rounded-2xl p-6 card-shadow text-center mb-6">
                <div class="text-sm text-slate-400 mb-1">ç¸½æ”¯å‡º (TWD)</div>
                <div class="text-4xl font-bold text-slate-800">{{ formatCurrency(totalExpense) }}</div>
                <div class="text-xs text-slate-400 mt-2">åŒ¯ç‡: {{ rate }}</div>
            </div>

            <div class="bg-white rounded-2xl p-4 card-shadow mb-6">
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <input v-model="newExpense.item" type="text" placeholder="é …ç›®" class="bg-slate-50 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <input v-model.number="newExpense.amount" type="number" placeholder="é‡‘é¡ (JPY)" class="bg-slate-50 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <button @click="addExpense" class="w-full bg-slate-900 text-white rounded-xl py-3 text-sm font-bold shadow-md active:scale-95 transition-transform">æ–°å¢æ”¯å‡º (åŒæ­¥)</button>
            </div>

            <div class="space-y-3">
                <div v-for="(exp, index) in expenses" :key="index" class="flex justify-between items-center bg-white p-4 rounded-xl border border-slate-50">
                    <span class="font-medium text-slate-700">{{ exp.item }}</span>
                    <div class="flex items-center gap-3">
                        <div class="text-right">
                            <div class="font-bold text-slate-900">Â¥{{ exp.amount }}</div>
                            <div class="text-xs text-slate-400">â‰ˆ NT${{ Math.round(exp.amount * rate) }}</div>
                        </div>
                        <button @click="removeExpense(index)" class="text-slate-300 hover:text-red-500 p-2"><i class="fa-solid fa-circle-minus"></i></button>
                    </div>
                </div>
                <div v-if="expenses.length === 0" class="text-center text-slate-400 text-sm mt-10">ç›®å‰æ²’æœ‰æ”¯å‡ºç´€éŒ„</div>
            </div>
        </div>
    </main>

    <button v-show="currentTab === 'trip'" @click="showAddModal = true" class="fixed bottom-24 right-6 bg-slate-900 text-white w-14 h-14 rounded-full shadow-xl shadow-slate-400/50 flex items-center justify-center active:scale-90 transition-transform z-10">
        <i class="fa-solid fa-plus text-xl"></i>
    </button>

    <div v-if="showAddModal" class="fixed inset-0 z-50 flex items-end justify-center sm:items-center p-4 bg-black/50 backdrop-blur-sm" @click.self="showAddModal = false">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl animate-slide-up">
            <h3 class="text-lg font-bold mb-4">æ–°å¢ Day {{ activeDay + 1 }} è¡Œç¨‹</h3>
            <div class="space-y-3">
                <div class="flex gap-2">
                    <input v-model="newItem.time" type="time" class="w-1/3 bg-slate-50 rounded-xl px-4 py-3 text-sm font-bold">
                    <select v-model="newItem.type" class="w-2/3 bg-slate-50 rounded-xl px-4 py-3 text-sm">
                        <option value="sightseeing">ğŸ“¸ æ™¯é»</option>
                        <option value="food">ğŸœ ç¾é£Ÿ</option>
                        <option value="buy">ğŸ›ï¸ è³¼ç‰©</option>
                        <option value="transport">ğŸš— äº¤é€š</option>
                    </select>
                </div>
                <input v-model="newItem.place" type="text" placeholder="åœ°é»åç¨±" class="w-full bg-slate-50 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500">
            </div>
            <div class="flex gap-3 mt-6">
                <button @click="showAddModal = false" class="flex-1 bg-slate-100 text-slate-600 py-3 rounded-xl font-medium">å–æ¶ˆ</button>
                <button @click="addScheduleItem" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg">æ–°å¢</button>
            </div>
        </div>
    </div>

    <nav class="bg-white/90 backdrop-blur-xl border-t border-slate-200 fixed bottom-0 w-full z-40 pb-safe">
        <div class="flex justify-around items-center h-16 safe-bottom">
            <button @click="currentTab = 'trip'" :class="currentTab === 'trip' ? 'text-indigo-600' : 'text-slate-400'" class="flex flex-col items-center gap-1 w-20 transition-colors">
                <i class="fa-solid fa-map-location-dot text-xl"></i>
                <span class="text-[10px] font-medium">è¡Œç¨‹</span>
            </button>
            <button @click="currentTab = 'utils'" :class="currentTab === 'utils' ? 'text-indigo-600' : 'text-slate-400'" class="flex flex-col items-center gap-1 w-20 transition-colors">
                <i class="fa-solid fa-suitcase text-xl"></i>
                <span class="text-[10px] font-medium">å·¥å…·</span>
            </button>
            <button @click="currentTab = 'budget'" :class="currentTab === 'budget' ? 'text-indigo-600' : 'text-slate-400'" class="flex flex-col items-center gap-1 w-20 transition-colors">
                <i class="fa-solid fa-wallet text-xl"></i>
                <span class="text-[10px] font-medium">è¨˜å¸³</span>
            </button>
        </div>
    </nav>
</div>

<!-- Firebase compat SDK (optional â€” ç”¨æ–¼é›²ç«¯åŒæ­¥)
     å¦‚æœä¸éœ€è¦é›²ç«¯åŒæ­¥ï¼Œå¯åˆªé™¤ä¸‹é¢å…©å€‹ <script> -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
/*
  é€™ä»½ script ä½¿ç”¨ Vue Global APIï¼ˆå·²åœ¨ <head> è¼‰å…¥ï¼‰
  - LocalStorage keys: jp_expenses, jp_itinerary
  - Firebase (compat) ç‚ºå¯é¸ï¼šè‹¥è¦å•Ÿç”¨é›²ç«¯åŒæ­¥è«‹å¡« firebaseConfigï¼›è‹¥ä¸éœ€è¦å¯æŠŠ firebaseConfig å…§å®¹ç•™ç©ºæˆ–ç§»é™¤ firebase éƒ¨åˆ†
*/

const firebaseConfig = {
  apiKey: "AIzaSyBM7ZkACa3GCyDHyM6-cvAptRdTLrP1Vz4",
  authDomain: "project-6278516196770343325.firebaseapp.com",
  projectId: "project-6278516196770343325",
  storageBucket: "project-6278516196770343325.firebasestorage.app",
  messagingSenderId: "1092753345526",
  appId: "1:1092753345526:web:83c76c77e00a6a2ad255d7",
  measurementId: "G-JZ408WWH2S"
};

let firebaseAvailable = false;
let firestoreDB = null;

try {
    if (window.firebase && firebaseConfig && firebaseConfig.projectId) {
        firebase.initializeApp(firebaseConfig);
        firestoreDB = firebase.firestore();
        firebaseAvailable = true;
        console.log("Firebase (compat) initialized.");
    }
} catch (e) {
    console.warn("Firebase init failed (continuing without cloud sync):", e);
}

/* default itinerary (same as ä½ åŸæœ¬çš„) */
const defaultItinerary = [
    { date: '1/19', location: 'åå¤å±‹', schedule: [
        { time: '13:00', place: 'åå¤å±‹ä¸­éƒ¨åœ‹éš›æ©Ÿå ´', type: 'transport' },
        { time: '16:12', place: 'æ¦®ç”ºå•†åœˆ', type: 'sightseeing', tips: [{tag: 'buy', text: 'å”å‰è¨¶å¾·'}, {tag: 'food', text: 'ç‚¸è¦ä¸‰æ˜æ²»'}] },
        { time: '17:18', place: 'å¯¶å¯å¤¢ä¸­å¿ƒ', type: 'sightseeing', tips: [{tag: 'buy', text: 'é™å®šçš®å¡ä¸˜'}, {tag: 'tip', text: 'å¯é€€ç¨…'}] }
    ]},
    { date: '1/20', location: 'ä¸‹å‘‚', schedule: [] },
    { date: '1/21', location: 'å¤§é˜ª', schedule: [] },
    { date: '1/22', location: 'USJ', schedule: [] },
    { date: '1/23', location: 'å¤§é˜ª', schedule: [] },
    { date: '1/24', location: 'å¥ˆè‰¯', schedule: [] },
    { date: '1/25', location: 'å¤§é˜ª', schedule: [] },
    { date: '1/26', location: 'å¤§é˜ª', schedule: [] },
    { date: '1/27', location: 'å¤§é˜ª', schedule: [] },
    { date: '1/28', location: 'è¿”ç¨‹', schedule: [] }
];

const { createApp } = Vue;

createApp({
    data() {
        return {
            // UI
            currentTab: 'trip',
            activeDay: 0,
            showAddModal: false,
            isSyncing: false,

            // rate & finance
            rate: 0.22,
            newExpense: { item: '', amount: '' },
            expenses: [],

            // itinerary / hotels
            newItem: { time: '10:00', place: '', type: 'sightseeing' },
            itinerary: JSON.parse(JSON.stringify(defaultItinerary)),
            hotels: [
                { name: '10-18 TakebashichÅ', address: 'Nagoya' },
                { name: 'äº¬é˜ªç’°çƒå½±åŸé£¯åº—é«˜å¡”', address: 'Osaka' },
                { name: 'Oceanå¿ƒæ–æ©‹', address: 'Osaka' }
            ]
        };
    },

    computed: {
        totalExpense() {
            // ç¸½æ”¯å‡ºï¼ˆJPY -> * rate = TWDï¼‰
            const sumJPY = this.expenses.reduce((s, i) => s + Number(i.amount || 0), 0);
            return sumJPY * this.rate;
        }
    },

    watch: {
        // è‡ªå‹•å„²å­˜ expenses èˆ‡ itinerary è‡³ localStorageï¼ˆæ·±å±¤ç›£è½ï¼‰
        expenses: {
            handler(newVal) {
                localStorage.setItem('jp_expenses', JSON.stringify(newVal));
                // è‹¥æœ‰ firebase å¯åŒæ­¥é›²ç«¯
                this.saveToCloudDebounced();
            },
            deep: true
        },
        itinerary: {
            handler(newVal) {
                localStorage.setItem('jp_itinerary', JSON.stringify(newVal));
                this.saveToCloudDebounced();
            },
            deep: true
        }
    },

    mounted() {
        // è®€ localStorage çš„æ”¯å‡ºèˆ‡è¡Œç¨‹ï¼ˆè‹¥æœ‰ï¼‰
        try {
            const saved = localStorage.getItem('jp_expenses');
            if (saved) this.expenses = JSON.parse(saved);

            const savedIt = localStorage.getItem('jp_itinerary');
            if (savedIt) {
                this.itinerary = JSON.parse(savedIt);
            } else {
                // é è¨­å¯«å…¥ default only if none
                localStorage.setItem('jp_itinerary', JSON.stringify(this.itinerary));
            }
        } catch (e) {
            console.warn('localStorage load error', e);
        }

        // å¦‚æœ firebase å¯ç”¨ï¼Œç›£è½é›²ç«¯è³‡æ–™ï¼ˆshared_trip_dataï¼‰
        if (firebaseAvailable && firestoreDB) {
            try {
                const docRef = firestoreDB.collection('trips').doc('shared_trip_data');
                docRef.onSnapshot((snap) => {
                    if (!snap.exists) return;
                    const data = snap.data();
                    // åˆä½µé›²ç«¯è³‡æ–™ï¼ˆä½†ä¸è¦†è“‹æœ¬åœ°ä¿®æ”¹ï¼‰
                    if (data.itinerary) {
                        // è‹¥ local æ²’æœ‰å‰‡è¦†è“‹ï¼Œæˆ–ï¼ˆä½ å¯ä»¥æ”¹æˆæ›´ç´°ç·»çš„åˆä½µé‚è¼¯ï¼‰
                        this.itinerary = data.itinerary;
                        localStorage.setItem('jp_itinerary', JSON.stringify(this.itinerary));
                    }
                    if (data.expenses) {
                        this.expenses = data.expenses;
                        localStorage.setItem('jp_expenses', JSON.stringify(this.expenses));
                    }
                });
            } catch (e) {
                console.warn('firebase onSnapshot error', e);
            }
        }
    },

    methods: {
        formatCurrency(v) {
            try {
                return new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 }).format(v);
            } catch {
                return v;
            }
        },

        // ========== Itinerary åŠŸèƒ½ ==========
        addScheduleItem() {
            if (!this.newItem.place) return;
            if (!this.itinerary[this.activeDay].schedule) this.itinerary[this.activeDay].schedule = [];
            this.itinerary[this.activeDay].schedule.push({ ...this.newItem });
            this.itinerary[this.activeDay].schedule.sort((a, b) => (a.time || '').localeCompare(b.time || ''));
            this.showAddModal = false;
            this.newItem = { time: '10:00', place: '', type: 'sightseeing' };
            // localStorage æœƒç”± watch è‡ªå‹•å­˜
        },

        removeScheduleItem(idx) {
            if (!confirm('åˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ')) return;
            this.itinerary[this.activeDay].schedule.splice(idx, 1);
        },

        // ========== è¨˜å¸³åŠŸèƒ½ ==========
        addExpense() {
            if (!this.newExpense.item || !this.newExpense.amount) return;
            // ä¿è­‰ amount æ˜¯æ•¸å­—
            const amount = Number(this.newExpense.amount);
            if (Number.isNaN(amount)) return;
            this.expenses.unshift({ item: this.newExpense.item, amount });
            this.newExpense = { item: '', amount: '' };
            // localStorage æœƒç”± watch è‡ªå‹•å­˜
        },

        removeExpense(index) {
            if (!confirm('åˆªé™¤æ­¤ç­†æ”¯å‡ºï¼Ÿ')) return;
            this.expenses.splice(index, 1);
        },

        // ========== å°å·¥å…· ==========
        findKujiShops() {
            if (navigator.geolocation) {
                alert('æ­£åœ¨åµæ¸¬ä½ çš„ä½ç½®...è«‹å…è¨± GPS æ¬Šé™');
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        window.open(`https://www.google.com/maps/search/ä¸€ç•ªãã˜/@${lat},${lng},14z`, '_blank');
                    },
                    (error) => {
                        window.open('https://www.google.com/maps/search/ä¸€ç•ªãã˜', '_blank');
                    }
                );
            } else {
                window.open('https://www.google.com/maps/search/ä¸€ç•ªãã˜', '_blank');
            }
        },

        // ========== æ¨£å¼ / æ¨™ç±¤ ==========
        getTypeColor(t) { return ({ sightseeing: 'bg-indigo-500', food: 'bg-orange-400', buy: 'bg-red-400', transport: 'bg-gray-500', hotel: 'bg-blue-600' }[t] || 'bg-slate-400'); },
        getTypeLabel(t) { return ({ sightseeing: 'æ™¯é»', food: 'ç¾é£Ÿ', buy: 'è³¼ç‰©', transport: 'äº¤é€š', hotel: 'ä½å®¿' }[t] || 'å…¶ä»–'); },
        getTipClass(tag) { return ({ food: 'tag-food', buy: 'tag-buy', tip: 'tag-tip' }[tag] || 'bg-gray-100'); },
        getTipIcon(tag) { return ({ food: 'fa-utensils', buy: 'fa-bag-shopping', tip: 'fa-circle-info' }[tag] || 'fa-star'); },

        getWeather(day) {
            const ws = [{temp: 8, icon: 'fa-sun', desc: 'æ™´'}, {temp: 2, icon: 'fa-snowflake', desc: 'é›ª'}, {temp: 10, icon: 'fa-cloud', desc: 'é™°'}, {temp: 9, icon: 'fa-sun', desc: 'æ™´'}, {temp: 7, icon: 'fa-cloud-rain', desc: 'é›¨'}];
            return ws[day % ws.length] || {temp: 10, icon: 'fa-sun', desc: 'æ™´'};
        },

        // ========== Cloud sync (optional) ==========
        async saveToCloud() {
            if (!firebaseAvailable || !firestoreDB) return;
            try {
                this.isSyncing = true;
                const docRef = firestoreDB.collection('trips').doc('shared_trip_data');
                await docRef.set({
                    itinerary: this.itinerary,
                    expenses: this.expenses,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (e) {
                console.warn('saveToCloud error', e);
            } finally {
                // çµ¦ UI ä¸€é»æ™‚é–“é¡¯ç¤ºåŒæ­¥ä¸­
                setTimeout(() => { this.isSyncing = false; }, 600);
            }
        },

        // simple debounce wrapper to avoid saving too frequently
        saveToCloudDebounced: (function() {
            let timer = null;
            return function() {
                if (timer) clearTimeout(timer);
                timer = setTimeout(() => {
                    this.saveToCloud();
                    timer = null;
                }, 800);
            };
        })()
    }
}).mount('#app');
</script>
</body>
</html>
