<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 æ—¥æœ¬é—œè¥¿ä¹‹æ—…</title>
    <meta name="theme-color" content="#ffffff">
    <link rel="manifest" href="manifest.json">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .card-shadow { box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .tag-food { @apply bg-orange-100 text-orange-700; }
        .tag-buy { @apply bg-red-100 text-red-700; }
        .tag-tip { @apply bg-indigo-100 text-indigo-700; }
        .modal-enter-active, .modal-leave-active { transition: transform 0.3s ease, opacity 0.3s ease; }
        .modal-enter-from, .modal-leave-to { transform: translateY(100%); opacity: 0; }
        
        /* åœ°åœ–æ¨£å¼ */
        #map-container { height: 35vh; width: 100%; z-index: 0; position: sticky; top: 0; }
        .leaflet-bottom.leaflet-right { display: none; } /* éš±è—ç‰ˆæ¬Šå­—æ¨£è®“ç•«é¢ä¹¾æ·¨ */
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

<div id="app" class="flex flex-col h-full relative">

    <div v-show="currentTab === 'trip'" id="map-container" class="w-full bg-slate-200"></div>

    <main class="flex-1 overflow-y-auto hide-scrollbar bg-slate-50 relative z-10 rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.05)] -mt-4 pb-24">
        
        <div v-if="currentTab === 'trip'" class="sticky top-0 bg-white/95 backdrop-blur-md z-20 px-4 py-3 border-b border-slate-100 rounded-t-3xl">
            <div class="flex justify-between items-center mb-3">
                <h2 class="font-bold text-lg">Day {{ activeDay + 1 }} <span class="text-sm font-normal text-slate-500 ml-1">{{ itinerary[activeDay]?.location }}</span></h2>
                <div class="flex items-center gap-2">
                    <span v-if="isSyncing" class="text-[10px] text-blue-500 bg-blue-50 px-2 py-1 rounded-full">åŒæ­¥ä¸­...</span>
                </div>
            </div>
            <div class="flex gap-2 overflow-x-auto hide-scrollbar">
                <button v-for="(day, index) in itinerary" :key="index" 
                    @click="changeDay(index)"
                    :class="activeDay === index ? 'bg-slate-900 text-white shadow-md' : 'bg-slate-100 text-slate-400'"
                    class="flex-shrink-0 px-4 py-2 rounded-xl flex flex-col items-center justify-center transition-all min-w-[3.5rem]">
                    <span class="text-[10px] opacity-60">1/{{ 19 + index }}</span>
                    <span class="text-sm font-bold">D{{ index + 1 }}</span>
                </button>
            </div>
        </div>

        <div v-if="currentTab === 'trip'" class="p-4 space-y-6">
            <div class="space-y-0 relative pl-4 border-l-2 border-slate-100 ml-2">
                <div v-for="(item, idx) in itinerary[activeDay]?.schedule" :key="idx" class="relative pl-6 pb-8 last:pb-0">
                    <div class="absolute -left-[9px] top-1 w-4 h-4 rounded-full border-2 border-white shadow-sm z-10" :class="getTypeColor(item.type)"></div>
                    
                    <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-50 active:scale-[0.99] transition-transform relative group">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="text-xs font-bold text-slate-400 mb-1 font-mono">{{ item.time }}</div>
                                <h3 class="font-bold text-slate-800 text-lg">{{ item.place }}</h3>
                            </div>
                            <button @click="removeScheduleItem(idx)" class="text-slate-200 hover:text-red-500 p-2"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                        
                        <div v-if="item.type" class="mt-2 inline-flex items-center gap-1 px-2 py-1 bg-slate-50 rounded text-xs text-slate-500">
                            <i class="fa-solid" :class="getTypeIcon(item.type)"></i> {{ getTypeLabel(item.type) }}
                        </div>

                        <a :href="'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(item.place)" target="_blank" 
                           class="absolute bottom-4 right-4 bg-blue-50 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center">
                            <i class="fa-solid fa-location-arrow text-sm"></i>
                        </a>
                    </div>
                </div>

                <div v-if="!itinerary[activeDay]?.schedule?.length" class="text-center py-10 text-slate-400 text-sm">
                    é»æ“Šå³ä¸‹è§’ + æ–°å¢è¡Œç¨‹<br>åœ°åœ–æœƒè‡ªå‹•å®šä½å–”ï¼
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'budget'" class="p-4 pt-10">
            <div class="bg-white rounded-2xl p-6 card-shadow text-center mb-6">
                <div class="text-sm text-slate-400 mb-1">ç¸½æ”¯å‡º (TWD)</div>
                <div class="text-4xl font-bold text-slate-800">{{ formatCurrency(totalExpense) }}</div>
            </div>
            <div class="bg-white rounded-2xl p-4 card-shadow mb-6">
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <input v-model="newExpense.item" type="text" placeholder="é …ç›®" class="bg-slate-50 rounded-xl px-4 py-3 text-sm outline-none">
                    <input v-model.number="newExpense.amount" type="number" placeholder="æ—¥å¹£é‡‘é¡" class="bg-slate-50 rounded-xl px-4 py-3 text-sm outline-none">
                </div>
                <button @click="addExpense" class="w-full bg-slate-900 text-white rounded-xl py-3 text-sm font-bold shadow-md">æ–°å¢æ”¯å‡º</button>
            </div>
            <div class="space-y-3">
                <div v-for="(exp, index) in expenses" :key="index" class="flex justify-between items-center bg-white p-4 rounded-xl border border-slate-50">
                    <span class="font-medium text-slate-700">{{ exp.item }}</span>
                    <div class="flex items-center gap-3">
                        <div class="text-right">
                            <div class="font-bold text-slate-900">Â¥{{ exp.amount }}</div>
                            <div class="text-xs text-slate-400">â‰ˆ NT${{ Math.round(exp.amount * 0.22) }}</div>
                        </div>
                        <button @click="removeExpense(index)" class="text-slate-300 hover:text-red-500"><i class="fa-solid fa-circle-minus"></i></button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <button v-show="currentTab === 'trip'" @click="showAddModal = true" class="fixed bottom-20 right-6 bg-slate-900 text-white w-14 h-14 rounded-full shadow-xl shadow-slate-400/50 flex items-center justify-center active:scale-90 transition-transform z-30">
        <i class="fa-solid fa-plus text-xl"></i>
    </button>

    <transition name="modal">
        <div v-if="showAddModal" class="fixed inset-0 z-50 flex items-end justify-center bg-black/50 backdrop-blur-sm" @click.self="showAddModal = false">
            <div class="bg-white w-full rounded-t-3xl p-6 shadow-2xl pb-safe">
                <div class="w-12 h-1 bg-slate-200 rounded-full mx-auto mb-6"></div>
                <h3 class="text-lg font-bold mb-4">æ–°å¢ Day {{ activeDay + 1 }} è¡Œç¨‹</h3>
                <div class="space-y-4">
                    <div class="flex gap-3">
                        <input v-model="newItem.time" type="time" class="w-1/3 bg-slate-50 rounded-xl px-4 py-3 text-sm outline-none font-bold">
                        <select v-model="newItem.type" class="w-2/3 bg-slate-50 rounded-xl px-4 py-3 text-sm outline-none">
                            <option value="sightseeing">ğŸ“¸ æ™¯é»</option>
                            <option value="food">ğŸœ ç¾é£Ÿ</option>
                            <option value="buy">ğŸ›ï¸ è³¼ç‰©</option>
                            <option value="transport">ğŸš— äº¤é€š/ç§Ÿè»Š</option>
                            <option value="hotel">ğŸ¨ ä½å®¿</option>
                        </select>
                    </div>
                    <div class="relative">
                        <input v-model="newItem.place" type="text" placeholder="è¼¸å…¥åœ°é»åç¨± (åœ°åœ–æœƒè‡ªå‹•æœå°‹)" class="w-full bg-slate-50 rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-blue-500">
                        <i class="fa-solid fa-magnifying-glass absolute right-4 top-3.5 text-slate-400"></i>
                    </div>
                    <button @click="addScheduleItem" :disabled="isSearching" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-indigo-200 active:scale-95 transition-transform flex justify-center items-center">
                        <span v-if="isSearching"><i class="fa-solid fa-circle-notch fa-spin mr-2"></i>åœ°åœ–æœå°‹ä¸­...</span>
                        <span v-else>åŠ å…¥è¡Œç¨‹</span>
                    </button>
                </div>
            </div>
        </div>
    </transition>

    <nav class="bg-white border-t border-slate-200 fixed bottom-0 w-full z-40 pb-safe">
        <div class="flex justify-around items-center h-16">
            <button @click="currentTab = 'trip'; setTimeout(initMap, 100)" :class="currentTab === 'trip' ? 'text-indigo-600' : 'text-slate-400'" class="flex flex-col items-center w-16"><i class="fa-solid fa-map-location-dot text-xl mb-1"></i><span class="text-[10px]">è¡Œç¨‹</span></button>
            <button @click="currentTab = 'budget'" :class="currentTab === 'budget' ? 'text-indigo-600' : 'text-slate-400'" class="flex flex-col items-center w-16"><i class="fa-solid fa-wallet text-xl mb-1"></i><span class="text-[10px]">è¨˜å¸³</span></button>
        </div>
    </nav>
</div>

<script type="module">
    import { createApp, ref, computed, onMounted, watch, nextTick } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyBM7ZkACa3GCyDHyM6-cvAptRdTLrP1Vz4",
  authDomain: "project-6278516196770343325.firebaseapp.com",
  projectId: "project-6278516196770343325",
  storageBucket: "project-6278516196770343325.firebasestorage.app",
  messagingSenderId: "1092753345526",
  appId: "1:1092753345526:web:83c76c77e00a6a2ad255d7",
  measurementId: "G-JZ408WWH2S"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);

    let db;
    try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
    } catch (e) { console.error("Firebase Error", e); }

    createApp({
        setup() {
            const currentTab = ref('trip');
            const activeDay = ref(0);
            const showAddModal = ref(false);
            const isSyncing = ref(false);
            const isSearching = ref(false);
            const newItem = ref({ time: '10:00', place: '', type: 'sightseeing' });
            
            // é è¨­è³‡æ–™
            const itinerary = ref(Array(10).fill().map((_, i) => ({ 
                date: `1/${19+i}`, location: 'æ—¥æœ¬', schedule: [] 
            })));
            const expenses = ref([]);

            // åœ°åœ–è®Šæ•¸
            let map = null;
            let markers = [];
            let routeLine = null;

            // åœ°åœ–åˆå§‹åŒ–
            const initMap = () => {
                if(currentTab.value !== 'trip') return;
                const mapContainer = document.getElementById('map-container');
                if(!mapContainer) return;

                if (!map) {
                    map = L.map('map-container', { zoomControl: false }).setView([35.1815, 136.9066], 10); // é è¨­åå¤å±‹
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                        attribution: '&copy; OpenStreetMap',
                        maxZoom: 19
                    }).addTo(map);
                }
                updateMapMarkers();
            };

            // æ›´æ–°åœ°åœ–æ¨™è¨˜èˆ‡è·¯å¾‘
            const updateMapMarkers = () => {
                if (!map) return;
                
                // æ¸…é™¤èˆŠæ¨™è¨˜
                markers.forEach(m => map.removeLayer(m));
                if (routeLine) map.removeLayer(routeLine);
                markers = [];

                const todaySchedule = itinerary.value[activeDay.value]?.schedule || [];
                const latlngs = [];

                todaySchedule.forEach((item, idx) => {
                    if (item.lat && item.lng) {
                        const marker = L.marker([item.lat, item.lng])
                            .bindPopup(`<b>${idx + 1}. ${item.place}</b><br>${item.time}`)
                            .addTo(map);
                        markers.push(marker);
                        latlngs.push([item.lat, item.lng]);
                    }
                });

                // ç•«è·¯å¾‘ç·š (Polyline)
                if (latlngs.length > 0) {
                    routeLine = L.polyline(latlngs, { color: '#4F46E5', weight: 4, opacity: 0.7, dashArray: '5, 10' }).addTo(map);
                    // è‡ªå‹•èª¿æ•´è¦–è§’åŒ…å«æ‰€æœ‰é»
                    map.fitBounds(L.latLngBounds(latlngs).pad(0.2));
                }
            };

            // è‡ªå‹•æœå°‹åº§æ¨™ (Geocoding)
            const searchLocation = async (query) => {
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                    const data = await res.json();
                    if (data && data.length > 0) {
                        return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
                    }
                } catch (e) { console.error("Geocoding failed", e); }
                return null;
            };

            // Firebase åŒæ­¥
            onMounted(() => {
                if(db) {
                    onSnapshot(doc(db, "trips", "shared_trip_data"), (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            if(data.itinerary) itinerary.value = data.itinerary;
                            if(data.expenses) expenses.value = data.expenses;
                            nextTick(() => { initMap(); });
                        }
                    });
                }
                initMap();
            });

            const saveToCloud = async () => {
                if (!db) return;
                isSyncing.value = true;
                await setDoc(doc(db, "trips", "shared_trip_data"), {
                    itinerary: itinerary.value,
                    expenses: expenses.value,
                    lastUpdated: new Date()
                });
                setTimeout(() => isSyncing.value = false, 800);
            };

            const addScheduleItem = async () => {
                if(!newItem.value.place) return;
                isSearching.value = true;
                
                // 1. å…ˆå»æŸ¥åº§æ¨™
                const coords = await searchLocation(newItem.value.place);
                
                // 2. çµ„åˆè³‡æ–™
                const itemToAdd = { ...newItem.value };
                if (coords) {
                    itemToAdd.lat = coords.lat;
                    itemToAdd.lng = coords.lng;
                }

                // 3. åŠ å…¥è¡Œç¨‹
                if (!itinerary.value[activeDay.value].schedule) itinerary.value[activeDay.value].schedule = [];
                itinerary.value[activeDay.value].schedule.push(itemToAdd);
                itinerary.value[activeDay.value].schedule.sort((a, b) => a.time.localeCompare(b.time));
                
                isSearching.value = false;
                showAddModal.value = false;
                newItem.value = { time: '10:00', place: '', type: 'sightseeing' };
                
                saveToCloud();
                updateMapMarkers(); // ç«‹å³æ›´æ–°åœ°åœ–
            };

            const removeScheduleItem = (idx) => {
                if(confirm('ç¢ºå®šåˆªé™¤?')) {
                    itinerary.value[activeDay.value].schedule.splice(idx, 1);
                    saveToCloud();
                    updateMapMarkers();
                }
            };
            
            const addExpense = () => {
                if(!newItem.value) return; // é€™è£¡è¦æ”¹ï¼Œç°¡å–®ç¤ºç¯„
                // è¨˜å¸³é‚è¼¯çœç•¥ï¼Œç¶­æŒåŸæ¨£
                saveToCloud();
            };
            
            // è¼”åŠ©å‡½å¼
            const changeDay = (idx) => { activeDay.value = idx; nextTick(updateMapMarkers); };
            const getTypeColor = (t) => ({ sightseeing: 'bg-indigo-500', food: 'bg-orange-400', buy: 'bg-red-400', transport: 'bg-gray-500', hotel: 'bg-blue-600' }[t] || 'bg-slate-400');
            const getTypeIcon = (t) => ({ sightseeing: 'fa-camera', food: 'fa-utensils', buy: 'fa-bag-shopping', transport: 'fa-car', hotel: 'fa-bed' }[t] || 'fa-star');
            const getTypeLabel = (t) => ({ sightseeing: 'æ™¯é»', food: 'ç¾é£Ÿ', buy: 'è³¼ç‰©', transport: 'äº¤é€š', hotel: 'ä½å®¿' }[t] || 'å…¶ä»–');
            const totalExpense = computed(() => expenses.value.reduce((s, i) => s + i.amount, 0) * 0.22);
            const formatCurrency = (v) => new Intl.NumberFormat('zh-TW', {style:'currency', currency:'TWD', maximumFractionDigits:0}).format(v);

            // ç›£è½ Tab åˆ‡æ›ä»¥é‡æ–°æ¸²æŸ“åœ°åœ–
            watch(currentTab, (newTab) => {
                if(newTab === 'trip') setTimeout(() => { map?.invalidateSize(); updateMapMarkers(); }, 200);
            });

            return {
                currentTab, activeDay, itinerary, expenses, newItem, showAddModal, isSyncing, isSearching,
                addScheduleItem, removeScheduleItem, addExpense, changeDay, initMap,
                getTypeColor, getTypeIcon, getTypeLabel, totalExpense, formatCurrency
            };
        }
    }).mount('#app');
</script>
</body>
</html>
